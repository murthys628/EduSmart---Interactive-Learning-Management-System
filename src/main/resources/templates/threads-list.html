<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="${pageTitle} ?: 'EduSmart | Discussion Forum'">EduSmart | Discussion Forum</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            min-height: 100vh;
            background: url('/images/studentthreads.jpg') no-repeat center center fixed;
            background-size: cover;
            font-family: Arial, sans-serif;
        }

        /* Sidebar */
        .sidebar {
            min-width: 220px;
            max-width: 220px;
            height: 100vh;
            position: fixed;
            top: 0;
            left: -220px;
            background: linear-gradient(to right top, #8b1e3f, #aa3a5f, #c7587f, #e0779f, #f399bf);
            color: white;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            z-index: 1050;
        }

        .sidebar.show { left: 0; }

        @media (min-width: 768px) {
            .sidebar { left: 0; }
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            font-weight: bold;
            font-size: 1.4rem;
        }

        .sidebar a, .sidebar button {
            display: block;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            margin-bottom: 5px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            background: transparent;
            border: none;
        }

        .sidebar a:hover, .sidebar button:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .sidebar a.active {
            background-color: rgba(255, 255, 255, 0.25);
        }

        .sidebar button { width: 100%; text-align: left; }

        /* Main content */
        .main-content {
            margin-left: 0;
            padding: 30px;
            min-height: 100vh;
            background: rgba(255, 255, 255, 0.85);
        }

        @media (min-width: 768px) {
            .main-content { margin-left: 240px; }
        }

        /* Sidebar toggle button */
        .sidebar-toggle {
            display: block;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1100;
            background: #8b1e3f;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
        }

        @media (min-width: 768px) {
            .sidebar-toggle { display: none; }
        }

        /* Cards */
        .card-light-bg {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card-light-bg:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>
<button class="sidebar-toggle" onclick="document.querySelector('.sidebar').classList.toggle('show')">‚ò∞</button>

<div class="sidebar d-flex flex-column">
    <h2>üéì Student Menu</h2>
    <a th:href="@{/student/dashboard}" class="text-white">üè† Dashboard</a>
    <a th:href="@{/student/courses}" class="text-white">üìö My Courses</a>
    <a th:href="@{/student/grades}" class="text-white">üìä Grades</a>
    <a th:href="@{/student/assignments}" class="text-white">üìù Assignments</a>
    <a th:href="@{/dashboard/discussions}" 
       th:classappend="${#strings.startsWith(currentURI, '/dashboard/discussions')} ? 'active' : ''"
       class="text-white">üí¨ Discussions</a>
    <a th:href="@{/student/profile}" class="text-white">üë§ Profile</a>
    <form th:action="@{/logout}" method="post" class="mt-auto">
        <button type="submit" class="w-100 btn btn-outline-light">Logout</button>
    </form>
</div>

<div class="main-content">
    <div class="container-fluid">
        <h1 class="mb-4"
				th:text="(${pageTitle} ?: 'Discussion Forum') + (courseId != null ? ' for Course ' + courseId : '')">
				Discussion Forum</h1>

			<p>Welcome, <span th:text="${currentUsername}">User</span></p>

        <div th:if="${successMessage}" class="alert alert-success" role="alert" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>

			<div class="row g-4 mt-3">
				<div
					class="col-12 d-flex justify-content-between align-items-center mb-3">
					<a th:href="@{/student/courses}" class="btn btn-outline-secondary">&lt;
						Back to Courses</a>
					
					<button class="btn btn-primary" data-bs-toggle="modal"
						data-bs-target="#newThreadModal">+ Start New Discussion</button>
				</div>

            <div class="col-12">
                <div class="table-responsive card p-3 card-light-bg">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Topic</th>
                                <th>Creator</th>
                                <th>Last Activity</th>
                                <th>Posts</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="thread : ${threads}" th:data-course-id="${thread.courseId}"> 
                                <td>
                                    <a th:href="@{/dashboard/discussions/{threadId}(threadId=${thread.id})}"
                                       th:text="${thread.title}" class="fw-bold">
                                        Example Thread Title
                                    </a>
                                </td>
                                <td th:text="${thread.creatorName}">Creator Name</td>
                                
                                <td th:text="${#temporals.format(thread.updatedAt, 'MMM dd, yyyy HH:mm')}">
                                    Oct 26, 2025 10:00
                                </td>
                                <td>
                                    <span class="badge bg-secondary" th:text="${thread.postCount} ?: 0">5</span>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(threads)}">
                                <td colspan="4" class="text-center">
                                    No discussion threads found. Click 'Start New Discussion' to create one.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="newThreadModal" tabindex="-1" aria-labelledby="newThreadModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="newThreadForm" th:action="@{/api/v1/threads}"> 
        <div class="modal-header">
          <h5 class="modal-title" id="newThreadModalLabel">Start New Discussion Thread</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="courseIdInput" name="courseId" th:value="${courseId}">
            
            <div class="mb-3">
                <label for="threadTitle" class="form-label">Thread Title</label>
                <input type="text" class="form-control" id="threadTitle" name="title" required
                       placeholder="A clear and concise topic...">
            </div>
            
            <div class="mb-3">
                <label for="threadDescription" class="form-label">Main Post Content</label>
                <textarea class="form-control" id="threadDescription" name="description" rows="4" required
                          placeholder="Write your initial post content here..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitThreadButton">Create Thread</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.querySelector('.sidebar-toggle').addEventListener('click', () => {
        document.querySelector('.sidebar').classList.toggle('show');
    });

    // --- NEW AJAX SUBMISSION LOGIC ---
    const form = document.getElementById('newThreadForm');
    const modalElement = document.getElementById('newThreadModal');

    form.addEventListener('submit', function(event) {
        event.preventDefault(); // Stop the default browser form submission

        const actionUrl = this.getAttribute('action');
        const submitButton = document.getElementById('submitThreadButton');
        
        submitButton.disabled = true;
        submitButton.textContent = 'Creating...';

        // 1. Attempt to get courseId from the hidden input (which pulls from the URL)
        let courseId = parseInt(document.getElementById('courseIdInput').value);

        // 2. üõë CRITICAL FALLBACK LOGIC: If courseId is NaN or missing (i.e., general view),
        //    try to find a course ID from the list using the data attribute we added.
        if (isNaN(courseId)) {
            // Looks for the first table row with the custom data attribute 'data-course-id'
            const firstThread = document.querySelector('tr[data-course-id]');
            if (firstThread) {
                // Fallback: Use the courseId of the first listed thread
                const fallbackId = firstThread.getAttribute('data-course-id');
                courseId = parseInt(fallbackId);
            }
        }
        
        // 3. Final Validation Check
        // Check if the value is *still* not a valid number after all attempts
        if (isNaN(courseId)) {
            alert('Error: Cannot determine the Course ID. Please navigate to a specific course discussion page to start a thread.');
            submitButton.disabled = false;
            submitButton.textContent = 'Create Thread';
            return; // Stop submission to prevent the backend SQL error
        }

        // 4. Gather remaining data and create JSON payload
        const payload = {
            title: document.getElementById('threadTitle').value,
            description: document.getElementById('threadDescription').value,
            courseId: courseId // Use the confirmed courseId
        };

        // 5. Send request using Fetch API
        fetch(actionUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json' // Crucial for Spring's @RequestBody
            },
            body: JSON.stringify(payload) // Convert JavaScript object to JSON string
        })
        .then(response => {
            if (response.ok) {
                // Thread created successfully
                alert('Discussion thread created successfully!');
                
                // Hide the modal (Bootstrap 5 way)
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) modal.hide();
                
                // Clear the form and refresh the page to see the new thread
                form.reset(); 
                window.location.reload(); 
            } else {
                // Handle API error (e.g., 400 validation, 500 error)
                return response.json().then(err => {
                    // Try to display a helpful message from the API, otherwise fall back
                    let errMsg = err.message || 'An unknown error occurred on the server.';
                    if (err.errors) { // Handle Spring validation errors
                        errMsg = "Validation failed: " + err.errors.map(e => e.defaultMessage).join(", ");
                    }
                    alert('Failed to create thread: ' + errMsg);
                    return Promise.reject(err);
                });
            }
        })
        .catch(error => {
            console.error('Error creating thread:', error);
            // Alert user about the failure
            if (!error.message.includes("Failed to create thread")) {
                alert('Failed to create thread. Check console for details.');
            }
        })
        .finally(() => {
            submitButton.disabled = false;
            submitButton.textContent = 'Create Thread';
        });
    });
</script>
</body>
</html>